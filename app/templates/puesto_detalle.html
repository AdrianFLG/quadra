@main.route('/puesto/<int:puesto_id>', methods=['GET', 'POST'])
def puesto_detalle(puesto_id):
    puesto = Puesto.query.get_or_404(puesto_id)
    form = CalificacionForm()

    if form.validate_on_submit():
        # Proteger para que solo usuarios logueados puedan comentar
        if not current_user.is_authenticated:
            flash('Debes iniciar sesión para dejar una calificación.', 'warning')
            return redirect(url_for('main.login'))

        # Verificar que el usuario no haya calificado ya este puesto
        calificacion_existente = Calificacion.query.filter_by(usuario_id=current_user.id, puesto_id=puesto.id).first()
        if calificacion_existente:
            flash('Ya has calificado este puesto.', 'info')
            return redirect(url_for('main.puesto_detalle', puesto_id=puesto.id))

        nueva_calificacion = Calificacion(
            puntuacion=form.puntuacion.data,
            comentario=form.comentario.data,
            autor=current_user,
            puesto=puesto
        )
        db.session.add(nueva_calificacion)
        db.session.commit()
        flash('¡Gracias por tu calificación!', 'success')
        return redirect(url_for('main.puesto_detalle', puesto_id=puesto.id))

    calificaciones = Calificacion.query.filter_by(puesto_id=puesto.id).order_by(Calificacion.fecha_creacion.desc()).all()
    return render_template('puesto_detalle.html', title=puesto.nombre, puesto=puesto, form=form, calificaciones=calificaciones)